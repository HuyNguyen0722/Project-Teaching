<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Products - Admin</title>
    <link rel="stylesheet" href="../../static/css/admin-dashboard.css" />
    <link rel="stylesheet" href="../../static/css/products.css" />
  </head>
  <body>
    <div class="sidebar">
      <div class="sidebar-header">
        <h3>Admin Panel</h3>
        <p id="adminUserName" class="admin-user-name"></p>
      </div>
      <ul class="sidebar-menu">
        <li><a href="dashboard.html">Dashboard</a></li>
        <li><a href="products.html" class="active">Products</a></li>
        <li><a href="orders.html">Orders</a></li>
        <li><a href="users.html">Users</a></li>
        <li><a href="coupons.html">Coupons</a></li>
        <li class="sidebar-footer-item">
          <button
            id="themeToggleBtn"
            class="action-btn secondary-btn sidebar-btn"
          >
            Toggle Dark Mode
          </button>
        </li>
        <li><a href="#" id="logoutBtn">Logout</a></li>
      </ul>
    </div>
    <div class="main-content">
      <header>
        <h1>Manage Products</h1>
        <a
          href="product-form.html"
          class="action-btn primary-btn header-add-btn"
          >Add New Product</a
        >
      </header>

      <section class="product-list-section">
        <h2>Current Products</h2>
        <div class="table-responsive">
          <table id="productsTable" class="data-table">
            <thead>
              <tr>
                <th>Image</th>
                <th>Name</th>
                <th>Category</th>
                <th>Price</th>
                <th>Stock</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="6">Loading products...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <script type="module" src="../../static/js/firebase-init.js"></script>
    <script type="module" src="../../static/js/admin-auth-check.js"></script>
    <script type="module" src="../../static/js/product-management.js"></script>
    <script type="module">
      import {
        getAllProducts,
        deleteProduct,
      } from "../../static/js/product-management.js";

      function formatVND(amount) {
        return new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
        }).format(amount);
      }

      document.addEventListener("DOMContentLoaded", async () => {
        const productsTableBody = document.querySelector(
          "#productsTable tbody"
        );

        async function displayProducts() {
          productsTableBody.innerHTML =
            '<tr><td colspan="6">Loading products...</td></tr>';
          try {
            const products = await getAllProducts();
            if (products.length === 0) {
              productsTableBody.innerHTML =
                '<tr><td colspan="6">No products found. Click "Add New Product" to add one!</td></tr>';
              return;
            }

            productsTableBody.innerHTML = products
              .map(
                (product) => `
                        <tr>
                            <td><img src="${
                              product.imageUrl ||
                              "https://via.placeholder.com/60x60?text=No+Image"
                            }" alt="${
                  product.name
                }" class="table-product-image"></td>
                            <td>${product.name}</td>
                            <td>${product.category || "N/A"}</td>
                            <td>${formatVND(product.price || 0)}</td>
                            <td>${product.stock}</td>
                            <td>
                                <a href="product-form.html?id=${
                                  product.id
                                }" class="action-btn edit-btn">Edit</a>
                                <button class="action-btn delete-btn" onclick="window.deleteProductHandler('${
                                  product.id
                                }', '${product.name}')">Delete</button>
                            </td>
                        </tr>
                    `
              )
              .join("");
          } catch (error) {
            productsTableBody.innerHTML = `<tr><td colspan="6" style="color: red;">Error loading products: ${error.message}</td></tr>`;
            console.error("Failed to display products:", error);
          }
        }

        window.deleteProductHandler = async (productId, productName) => {
          if (
            confirm(`Are you sure you want to delete product "${productName}"?`)
          ) {
            try {
              await deleteProduct(productId);
              alert("Product deleted successfully!");
              await displayProducts();
            } catch (error) {
              alert(`Failed to delete product: ${error.message}`);
              console.error("Product deletion error:", error);
            }
          }
        };

        await displayProducts();
      });
    </script>
  </body>
</html>
