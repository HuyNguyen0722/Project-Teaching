<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Products - Admin</title>
    <link rel="stylesheet" href="../../static/css/admin-dashboard.css" />
    <link rel="stylesheet" href="../../static/css/products.css" />
  </head>
  <body>
    <div class="sidebar">
      <div class="sidebar-header">
        <h3>Admin Panel</h3>
      </div>
      <ul class="sidebar-menu">
        <li><a href="dashboard.html">Dashboard</a></li>
        <li><a href="products.html" class="active">Products</a></li>
        <li><a href="orders.html">Orders</a></li>
        <li><a href="users.html">Users</a></li>
        <li><a href="coupons.html">Coupons</a></li>
        <li><a href="#" id="logoutBtn">Logout</a></li>
      </ul>
    </div>
    <div class="main-content">
      <header>
        <h1>Manage Products</h1>
        <button
          id="addNewProductBtn"
          class="action-btn primary-btn header-add-btn"
        >
          Add New Product
        </button>
      </header>

      <section class="product-list-section">
        <h2>Current Products</h2>
        <div class="table-responsive">
          <table id="productsTable" class="data-table">
            <thead>
              <tr>
                <th>Image</th>
                <th>Name</th>
                <th>Category</th>
                <th>Price</th>
                <th>Stock</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="6">Loading products...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <div id="productModal" class="modal">
      <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2 id="modalTitle">Add New Product</h2>
        <form id="productForm">
          <input type="hidden" id="productId" />
          <div class="form-group">
            <label for="productName">Product Name:</label>
            <input type="text" id="productName" required />
          </div>

          <div class="form-group">
            <label for="productDescription">Description:</label>
            <textarea id="productDescription" rows="4"></textarea>
          </div>

          <div class="form-group">
            <label for="productPrice">Price:</label>
            <input type="number" id="productPrice" step="0.01" required />
          </div>

          <div class="form-group">
            <label for="productStock">Stock:</label>
            <input type="number" id="productStock" required />
          </div>

          <div class="form-group">
            <label for="productCategory">Category:</label>
            <input type="text" id="productCategory" />
          </div>

          <div class="form-group">
            <label for="productImage">Product Image:</label>
            <input type="file" id="productImage" accept="image/*" />
            <img
              id="currentProductImage"
              src=""
              alt="Current Product Image"
              class="product-image-preview"
            />
          </div>

          <button type="submit" id="saveProductBtn" class="primary-btn">
            Add Product
          </button>
          <button type="button" id="cancelEditBtn" class="secondary-btn">
            Cancel
          </button>
        </form>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyDhRhLAvh22RAYh_6rELSYHMd2AaY51Ruw",
        authDomain: "project-teaching-89801.firebaseapp.com",
        projectId: "project-teaching-89801",
        storageBucket: "project-teaching-89801.firebasestorage.app",
        messagingSenderId: "441282021443",
        appId: "1:441282021443:web:223ef629568b9b6e39acf6",
        measurementId: "G-KB0ZT3GR3K",
      };

      // Initialize Firebase (giữ nguyên)
      const app = firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
      const storage = firebase.storage();
    </script>
    <script src="../../static/js/admin-auth-check.js"></script>
    <script src="../../static/js/product-management.js"></script>
    <script>
      // Logic cụ thể cho trang products.html (CẬP NHẬT RẤT NHIỀU)
      document.addEventListener("DOMContentLoaded", async () => {
        // Get modal elements
        const productModal = document.getElementById("productModal");
        const closeButton = document.querySelector(".close-button");
        const addNewProductBtn = document.getElementById("addNewProductBtn");
        const modalTitle = document.getElementById("modalTitle");

        // Form elements
        const productForm = document.getElementById("productForm");
        const productIdInput = document.getElementById("productId");
        const productNameInput = document.getElementById("productName");
        const productDescriptionInput =
          document.getElementById("productDescription");
        const productPriceInput = document.getElementById("productPrice");
        const productStockInput = document.getElementById("productStock");
        const productCategoryInput = document.getElementById("productCategory");
        const productImageInput = document.getElementById("productImage");
        const currentProductImage = document.getElementById(
          "currentProductImage"
        );
        const saveProductBtn = document.getElementById("saveProductBtn");
        const cancelEditBtn = document.getElementById("cancelEditBtn"); // Changed type to button

        const productsTableBody = document.querySelector(
          "#productsTable tbody"
        ); // Lấy tbody của bảng

        // Function to open modal
        function openModal(isEditMode = false) {
          if (!isEditMode) {
            productForm.reset();
            productIdInput.value = "";
            currentProductImage.style.display = "none";
            currentProductImage.src = ""; // Clear image src
            saveProductBtn.textContent = "Add Product";
            modalTitle.textContent = "Add New Product";
          }
          productModal.style.display = "flex"; // Use flex to center the modal
        }

        // Function to close modal
        function closeModal() {
          productModal.style.display = "none";
          productForm.reset();
          productIdInput.value = "";
          currentProductImage.style.display = "none";
          currentProductImage.src = ""; // Clear image src
          saveProductBtn.textContent = "Add Product";
          modalTitle.textContent = "Add New Product";
        }

        // Event listeners for modal
        addNewProductBtn.addEventListener("click", () => openModal(false));
        closeButton.addEventListener("click", closeModal);
        cancelEditBtn.addEventListener("click", closeModal);

        // Close modal when clicking outside of it
        window.addEventListener("click", (event) => {
          if (event.target == productModal) {
            closeModal();
          }
        });

        // Hàm hiển thị danh sách sản phẩm (CẬP NHẬT ĐỂ TẠO BẢNG)
        async function displayProducts() {
          productsTableBody.innerHTML =
            '<tr><td colspan="6">Loading products...</td></tr>';
          try {
            const products = await getAllProducts();
            if (products.length === 0) {
              productsTableBody.innerHTML =
                '<tr><td colspan="6">No products found. Click "Add New Product" to add one!</td></tr>';
              return;
            }

            productsTableBody.innerHTML = products
              .map(
                (product) => `
                        <tr>
                            <td><img src="${
                              product.imageUrl ||
                              "https://via.placeholder.com/60x60?text=No+Image"
                            }" alt="${
                  product.name
                }" class="table-product-image"></td>
                            <td>${product.name}</td>
                            <td>${product.category || "N/A"}</td>
                            <td>$${
                              product.price ? product.price.toFixed(2) : "0.00"
                            }</td>
                            <td>${product.stock}</td>
                            <td>
                                <button onclick="editProduct('${
                                  product.id
                                }')" class="action-btn edit-btn">Edit</button>
                                <button class="action-btn delete-btn" onclick="deleteProductHandler('${
                                  product.id
                                }', '${product.name}')">Delete</button>
                            </td>
                        </tr>
                    `
              )
              .join("");
          } catch (error) {
            productsTableBody.innerHTML = `<tr><td colspan="6" style="color: red;">Error loading products: ${error.message}</td></tr>`;
            console.error("Failed to display products:", error);
          }
        }

        // Xử lý Form Submit (Thêm / Cập nhật sản phẩm) - GIỮ NGUYÊN LOGIC
        productForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          const productId = productIdInput.value;
          const productData = {
            name: productNameInput.value,
            description: productDescriptionInput.value,
            price: parseFloat(productPriceInput.value),
            stock: parseInt(productStockInput.value),
            category: productCategoryInput.value,
          };
          const imageFile = productImageInput.files[0];

          try {
            if (productId) {
              await updateProduct(productId, productData, imageFile);
              alert("Product updated successfully!");
            } else {
              await addProduct(productData, imageFile);
              alert("Product added successfully!");
            }
            closeModal();
            await displayProducts();
          } catch (error) {
            alert(`Operation failed: ${error.message}`);
            console.error("Product form submission error:", error);
          }
        });

        // Hàm nạp dữ liệu vào form để chỉnh sửa - GIỮ NGUYÊN LOGIC
        window.editProduct = async (productId) => {
          try {
            const product = await getProductById(productId);
            if (product) {
              productIdInput.value = product.id;
              productNameInput.value = product.name;
              productDescriptionInput.value = product.description;
              productPriceInput.value = product.price;
              productStockInput.value = product.stock;
              productCategoryInput.value = product.category;
              saveProductBtn.textContent = "Update Product";
              modalTitle.textContent = "Edit Product";

              if (product.imageUrl) {
                currentProductImage.src = product.imageUrl;
                currentProductImage.style.display = "block";
              } else {
                currentProductImage.style.display = "none";
              }
              productImageInput.value = "";
              openModal(true);
            }
          } catch (error) {
            console.error("Error fetching product for edit:", error);
            alert("Could not load product for editing.");
          }
        };

        // Hàm xử lý xóa sản phẩm - GIỮ NGUYÊN LOGIC
        window.deleteProductHandler = async (productId, productName) => {
          if (
            confirm(`Are you sure you want to delete product "${productName}"?`)
          ) {
            try {
              await deleteProduct(productId);
              alert("Product deleted successfully!");
              await displayProducts();
            } catch (error) {
              alert(`Failed to delete product: ${error.message}`);
              console.error("Product deletion error:", error);
            }
          }
        };

        // Logic đăng xuất (giữ nguyên)
        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", async (e) => {
            e.preventDefault();
            try {
              await auth.signOut();
              window.location.href = "auth.html";
            } catch (error) {
              console.error("Logout Error:", error);
              alert("Error logging out. Please try again.");
            }
          });
        }

        await displayProducts();
      });
    </script>
  </body>
</html>
