<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Orders - Admin</title>
    <link rel="stylesheet" href="../../static/css/admin-dashboard.css" />
    <link rel="stylesheet" href="../../static/css/orders.css" />
  </head>
  <body>
    <div class="sidebar">
      <div class="sidebar-header">
        <h3>Admin Panel</h3>
        <p id="adminUserName" class="admin-user-name"></p>
      </div>
      <ul class="sidebar-menu">
        <li><a href="dashboard.html">Dashboard</a></li>
        <li><a href="products.html">Products</a></li>
        <li><a href="orders.html" class="active">Orders</a></li>
        <li><a href="users.html">Users</a></li>
        <li><a href="coupons.html">Coupons</a></li>
        <li class="sidebar-footer-item">
          <button
            id="themeToggleBtn"
            class="action-btn secondary-btn sidebar-btn"
          >
            Toggle Dark Mode
          </button>
        </li>
        <li><a href="#" id="logoutBtn">Logout</a></li>
      </ul>
    </div>
    <div class="main-content">
      <header>
        <h1>Manage Orders</h1>
      </header>

      <section class="order-list-section">
        <h2>Current Orders</h2>
        <div class="table-responsive">
          <table id="ordersTable" class="data-table">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Total</th>
                <th>Status</th>
                <th>Order Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="6">Loading orders...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <script type="module" src="../../static/js/firebase-init.js"></script>
    <script type="module" src="../../static/js/admin-auth-check.js"></script>
    <script type="module" src="../../static/js/order-management.js"></script>
    <script type="module">
      import {
        getAllOrders,
        deleteOrder,
      } from "../../static/js/order-management.js";

      function formatVND(amount) {
        return new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
        }).format(amount);
      }

      document.addEventListener("DOMContentLoaded", async () => {
        const ordersTableBody = document.querySelector("#ordersTable tbody");

        async function displayOrders() {
          ordersTableBody.innerHTML =
            '<tr><td colspan="6">Loading orders...</td></tr>';
          try {
            const orders = await getAllOrders();
            if (orders.length === 0) {
              ordersTableBody.innerHTML =
                '<tr><td colspan="6">No orders found.</td></tr>';
              return;
            }

            ordersTableBody.innerHTML = orders
              .map((order) => {
                const orderDate = order.orderDate
                  ? new Date(order.orderDate.seconds * 1000).toLocaleString()
                  : "N/A";
                const customerName = order.customerInfo
                  ? order.customerInfo.name || "N/A"
                  : "N/A";
                const totalAmount = order.totalAmount
                  ? formatVND(order.totalAmount)
                  : formatVND(0);
                const statusClass = `status-${
                  order.status ? order.status.toLowerCase() : "pending"
                }`;

                return `
                                <tr>
                                    <td>${order.id}</td>
                                    <td>${customerName}</td>
                                    <td>${totalAmount}</td>
                                    <td><span class="status-badge ${statusClass}">${
                  order.status || "Pending"
                }</span></td>
                                    <td>${orderDate}</td>
                                    <td>
                                        <a href="order-form.html?id=${
                                          order.id
                                        }" class="action-btn view-btn">View/Edit</a>
                                        <button class="action-btn delete-btn" onclick="window.deleteOrderHandler('${
                                          order.id
                                        }')">Delete</button>
                                    </td>
                                </tr>
                            `;
              })
              .join("");
          } catch (error) {
            ordersTableBody.innerHTML = `<tr><td colspan="6" style="color: red;">Error loading orders: ${error.message}</td></tr>`;
            console.error("Failed to display orders:", error);
          }
        }

        window.deleteOrderHandler = async (orderId) => {
          if (
            confirm(`Are you sure you want to delete order ID: ${orderId}?`)
          ) {
            try {
              await deleteOrder(orderId);
              alert("Order deleted successfully!");
              await displayOrders();
            } catch (error) {
              alert(`Failed to delete order: ${error.message}`);
              console.error("Order deletion error:", error);
            }
          }
        };

        await displayOrders();
      });
    </script>
  </body>
</html>
