<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Coupons - Admin</title>
    <link rel="stylesheet" href="../../static/css/admin-dashboard.css" />
    <link rel="stylesheet" href="../../static/css/coupons.css" />
  </head>
  <body>
    <div class="sidebar">
      <div class="sidebar-header">
        <h3>Admin Panel</h3>
        <p id="adminUserName" class="admin-user-name"></p>
      </div>
      <ul class="sidebar-menu">
        <li><a href="dashboard.html">Dashboard</a></li>
        <li><a href="products.html">Products</a></li>
        <li><a href="orders.html">Orders</a></li>
        <li><a href="users.html">Users</a></li>
        <li><a href="coupons.html" class="active">Coupons</a></li>
        <li class="sidebar-footer-item">
          <button
            id="themeToggleBtn"
            class="action-btn secondary-btn sidebar-btn"
          >
            Toggle Dark Mode
          </button>
        </li>
        <li><a href="#" id="logoutBtn">Logout</a></li>
      </ul>
    </div>
    <div class="main-content">
      <header>
        <h1>Manage Coupons</h1>
        <a href="coupon-form.html" class="action-btn primary-btn header-add-btn"
          >Add New Coupon</a
        >
      </header>

      <section class="coupon-list-section">
        <h2>Current Coupons</h2>
        <div class="table-responsive">
          <table id="couponsTable" class="data-table">
            <thead>
              <tr>
                <th>Code</th>
                <th>Type</th>
                <th>Value</th>
                <th>Min Order</th>
                <th>Uses</th>
                <th>Valid Until</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="8">Loading coupons...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <script type="module" src="../../static/js/firebase-init.js"></script>
    <script type="module" src="../../static/js/admin-auth-check.js"></script>
    <script type="module" src="../../static/js/coupon-management.js"></script>
    <script type="module">
      import {
        getAllCoupons,
        deleteCoupon,
      } from "../../static/js/coupon-management.js";

      function formatVND(amount) {
        return new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
        }).format(amount);
      }

      document.addEventListener("DOMContentLoaded", async () => {
        const couponsTableBody = document.querySelector("#couponsTable tbody");

        async function displayCoupons() {
          couponsTableBody.innerHTML =
            '<tr><td colspan="8">Loading coupons...</td></tr>';
          try {
            const coupons = await getAllCoupons();
            if (coupons.length === 0) {
              couponsTableBody.innerHTML =
                '<tr><td colspan="8">No coupons found. Click "Add New Coupon" to create one!</td></tr>';
              return;
            }

            couponsTableBody.innerHTML = coupons
              .map((coupon) => {
                const valueDisplay =
                  coupon.type === "percentage"
                    ? `${(coupon.value * 100).toFixed(0)}%`
                    : formatVND(coupon.value || 0);
                const minOrderDisplay = coupon.minimumOrderAmount
                  ? formatVND(coupon.minimumOrderAmount)
                  : "None";
                const validUntilDate = coupon.validUntil
                  ? new Date(coupon.validUntil.seconds * 1000)
                  : null;
                const validUntilDisplay = validUntilDate
                  ? validUntilDate.toLocaleDateString()
                  : "N/A";

                let statusText = "Inactive";
                let statusClass = "coupon-inactive";
                if (coupon.isActive) {
                  if (validUntilDate && validUntilDate < new Date()) {
                    statusText = "Expired";
                    statusClass = "coupon-expired";
                  } else {
                    statusText = "Active";
                    statusClass = "coupon-active";
                  }
                }

                return `
                            <tr>
                                <td>${coupon.code}</td>
                                <td>${coupon.type}</td>
                                <td>${valueDisplay}</td>
                                <td>${minOrderDisplay}</td>
                                <td>${coupon.usesCount || 0}/${
                  coupon.maxUses === 0 ? "âˆž" : coupon.maxUses
                }</td>
                                <td>${validUntilDisplay}</td>
                                <td><span class="coupon-badge ${statusClass}">${statusText}</span></td>
                                <td>
                                    <a href="coupon-form.html?id=${
                                      coupon.id
                                    }" class="action-btn edit-btn">Edit</a>
                                    <button class="action-btn delete-btn" onclick="window.deleteCouponHandler('${
                                      coupon.id
                                    }', '${coupon.code}')">Delete</button>
                                </td>
                            </tr>
                        `;
              })
              .join("");
          } catch (error) {
            couponsTableBody.innerHTML = `<tr><td colspan="8" style="color: red;">Error loading coupons: ${error.message}</td></tr>`;
            console.error("Failed to display coupons:", error);
          }
        }

        window.deleteCouponHandler = async (couponId, couponCode) => {
          if (
            confirm(
              `Are you sure you want to delete coupon "${couponCode}"? This action cannot be undone.`
            )
          ) {
            try {
              await deleteCoupon(couponId);
              alert("Coupon deleted successfully!");
              await displayCoupons();
            } catch (error) {
              alert(`Failed to delete coupon: ${error.message}`);
              console.error("Coupon deletion error:", error);
            }
          }
        };

        await displayCoupons();
      });
    </script>
  </body>
</html>
