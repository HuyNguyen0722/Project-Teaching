<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Users - Admin</title>
    <link rel="stylesheet" href="../../static/css/admin-dashboard.css" />
    <link rel="stylesheet" href="../../static/css/users.css" />
  </head>
  <body>
    <div class="sidebar">
      <div class="sidebar-header">
        <h3>Admin Panel</h3>
        <p id="adminUserName" class="admin-user-name"></p>
      </div>
      <ul class="sidebar-menu">
        <li><a href="dashboard.html">Dashboard</a></li>
        <li><a href="products.html">Products</a></li>
        <li><a href="orders.html">Orders</a></li>
        <li><a href="users.html" class="active">Users</a></li>
        <li><a href="coupons.html">Coupons</a></li>
        <li class="sidebar-footer-item">
          <button
            id="themeToggleBtn"
            class="action-btn secondary-btn sidebar-btn"
          >
            Toggle Dark Mode
          </button>
        </li>
        <li><a href="#" id="logoutBtn">Logout</a></li>
      </ul>
    </div>
    <div class="main-content">
      <header>
        <h1>Manage Users</h1>
      </header>

      <section class="user-list-section">
        <h2>Current Users</h2>
        <div class="table-responsive">
          <table id="usersTable" class="data-table">
            <thead>
              <tr>
                <th>Email</th>
                <th>Role</th>
                <th>Name</th>
                <th>Phone</th>
                <th>Created At</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="6">Loading users...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <script type="module" src="../../static/js/firebase-init.js"></script>
    <script type="module" src="../../static/js/admin-auth-check.js"></script>
    <script type="module" src="../../static/js/user-management.js"></script>
    <script type="module">
      import {
        getAllUsers,
        deleteUser,
      } from "../../static/js/user-management.js";

      document.addEventListener("DOMContentLoaded", async () => {
        const usersTableBody = document.querySelector("#usersTable tbody");

        async function displayUsers() {
          usersTableBody.innerHTML =
            '<tr><td colspan="6">Loading users...</td></tr>';
          try {
            const users = await getAllUsers();
            if (users.length === 0) {
              usersTableBody.innerHTML =
                '<tr><td colspan="6">No users found.</td></tr>';
              return;
            }

            usersTableBody.innerHTML = users
              .map((user) => {
                const createdAt = user.createdAt
                  ? new Date(user.createdAt.seconds * 1000).toLocaleString()
                  : "N/A";
                const roleClass = `role-${user.role || "customer"}`;
                return `
                            <tr>
                                <td>${user.email}</td>
                                <td><span class="role-badge ${roleClass}">${
                  user.role || "customer"
                }</span></td>
                                <td>${user.firstName || "N/A"} ${
                  user.lastName || ""
                }</td>
                                <td>${user.phone || "N/A"}</td>
                                <td>${createdAt}</td>
                                <td>
                                    <a href="user-form.html?id=${
                                      user.id
                                    }" class="action-btn view-btn">View/Edit Role</a>
                                    <button class="action-btn delete-btn" onclick="window.deleteUserHandler('${
                                      user.id
                                    }', '${user.email}')">Delete</button>
                                </td>
                            </tr>
                        `;
              })
              .join("");
          } catch (error) {
            usersTableBody.innerHTML = `<tr><td colspan="6" style="color: red;">Error loading users: ${error.message}</td></tr>`;
            console.error("Failed to display users:", error);
          }
        }

        window.deleteUserHandler = async (userId, userEmail) => {
          if (
            confirm(
              `Are you sure you want to delete user "${userEmail}"? This action cannot be undone.`
            )
          ) {
            try {
              await deleteUser(userId);
              alert("User deleted successfully!");
              await displayUsers();
            } catch (error) {
              alert(`Failed to delete user: ${error.message}`);
              console.error("User deletion error:", error);
            }
          }
        };

        await displayUsers();
      });
    </script>
  </body>
</html>
