<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Your E-commerce</title>
    <link rel="stylesheet" href="../../static/css/admin-dashboard.css" />
    <link rel="stylesheet" href="../../static/css/orders.css" />
  </head>
  <body>
    <div class="sidebar">
      <div class="sidebar-header">
        <h3>Admin Panel</h3>
        <p id="adminUserName" class="admin-user-name"></p>
      </div>
      <ul class="sidebar-menu">
        <li><a href="dashboard.html" class="active">Dashboard</a></li>
        <li><a href="products.html">Products</a></li>
        <li><a href="orders.html">Orders</a></li>
        <li><a href="users.html">Users</a></li>
        <li><a href="coupons.html">Coupons</a></li>
        <li class="sidebar-footer-item">
          <button
            id="themeToggleBtn"
            class="action-btn secondary-btn sidebar-btn"
          >
            Toggle Dark Mode
          </button>
        </li>
        <li><a href="#" id="logoutBtn">Logout</a></li>
      </ul>
    </div>
    <div class="main-content">
      <header>
        <h1>Dashboard Overview</h1>
      </header>
      <section class="stats-grid">
        <div class="stat-card">
          <h3>Total Sales</h3>
          <p><span id="totalSales">0.00</span></p>
        </div>
        <div class="stat-card">
          <h3>Total Orders</h3>
          <p><span id="totalOrders">0</span></p>
        </div>
        <div class="stat-card">
          <h3>New Users (Today)</h3>
          <p><span id="newUsersToday">0</span></p>
        </div>
      </section>

      <section class="recent-activity">
        <h2>Recent Orders</h2>
        <div class="table-responsive">
          <table id="recentOrdersTable" class="data-table">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Total</th>
                <th>Status</th>
                <th>Order Date</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="5">Loading recent orders...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </div>

    <script type="module" src="../../static/js/firebase-init.js"></script>
    <script type="module" src="../../static/js/admin-auth-check.js"></script>
    <script type="module" src="../../static/js/order-management.js"></script>
    <script type="module" src="../../static/js/user-management.js"></script>
    <script type="module">
      import { db } from "../../static/js/firebase-init.js";
      import {
        collection,
        getDocs,
        orderBy,
        query,
        where,
        Timestamp,
      } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
      import { getAllOrders } from "../../static/js/order-management.js";
      import { getAllUsers } from "../../static/js/user-management.js";

      function formatVND(amount) {
        return new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
        }).format(amount);
      }

      document.addEventListener("DOMContentLoaded", async () => {
        const totalSalesSpan = document.getElementById("totalSales");
        const totalOrdersSpan = document.getElementById("totalOrders");
        const newUsersTodaySpan = document.getElementById("newUsersToday");
        const recentOrdersTableBody = document.querySelector(
          "#recentOrdersTable tbody"
        );

        async function loadDashboardStats() {
          try {
            const orders = await getAllOrders();
            let totalSales = 0;
            let totalOrders = orders.length;

            recentOrdersTableBody.innerHTML = "";
            if (orders.length === 0) {
              recentOrdersTableBody.innerHTML =
                '<tr><td colspan="5">No recent orders.</td></tr>';
            } else {
              const latestOrders = orders.slice(0, 5);

              latestOrders.forEach((order) => {
                totalSales += order.totalAmount || 0;
                const orderDate = order.orderDate
                  ? new Date(order.orderDate.seconds * 1000).toLocaleString()
                  : "N/A";
                const customerName = order.customerInfo
                  ? order.customerInfo.name || "N/A"
                  : "N/A";
                const totalAmountFormatted = order.totalAmount
                  ? formatVND(order.totalAmount)
                  : formatVND(0);
                const statusClass = `status-${
                  order.status ? order.status.toLowerCase() : "pending"
                }`;

                recentOrdersTableBody.innerHTML += `
                                <tr>
                                    <td>${order.id}</td>
                                    <td>${customerName}</td>
                                    <td>${totalAmountFormatted}</td>
                                    <td><span class="status-badge ${statusClass}">${
                  order.status || "Pending"
                }</span></td>
                                    <td>${orderDate}</td>
                                </tr>
                            `;
              });
            }

            totalSalesSpan.textContent = formatVND(totalSales);
            totalOrdersSpan.textContent = totalOrders;

            const users = await getAllUsers();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const newUsersTodayCount = users.filter((user) => {
              if (user.createdAt && user.createdAt.seconds) {
                return new Date(user.createdAt.seconds * 1000) >= today;
              }
              return false;
            }).length;

            newUsersTodaySpan.textContent = newUsersTodayCount;
          } catch (error) {
            console.error("Error loading dashboard stats:", error);
            totalSalesSpan.textContent = formatVND(0);
            totalOrdersSpan.textContent = "Error";
            newUsersTodaySpan.textContent = "Error";
            recentOrdersTableBody.innerHTML =
              '<tr><td colspan="5" style="color: red;">Error loading data.</td></tr>';
          }
        }

        await loadDashboardStats();
      });
    </script>
  </body>
</html>
